---

########################################
## Bootstrap Ansible, installing Python
########################################


- hosts: bastion
  gather_facts: false
  tasks:
    - name: Wait until SSH is ready on Bastion
      local_action: wait_for port=22 host="{{ ec2_ip_address }}" search_regex="OpenSSH" timeout=300 state=started

    # TODO Should also wait for port 22 on internal nodes, but connecting through the Bastion. 'local_action: wait_for' doesn't work it the host is an internal IP 

- hosts: etcd # We don't need Python on Bastion. We are not going to install anything on it.
  gather_facts: false
  tasks:

    - name: Install Python
      # Assumes Ubuntu 16.04 on all instances
      raw: "apt-get -y -q install python"
      become: true
      retries: 10
      delay: 30
      # If you run this playbook immediately after Terraform, ssh may not be ready to respond yet
